name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.4.0)'
        required: true
        type: string
      draft:
        description: 'Create as draft release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Validate version format
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "Invalid version format: $VERSION"
            echo "Expected format: MAJOR.MINOR.PATCH (e.g., 1.4.0)"
            exit 1
          fi
          echo "Version format is valid: $VERSION"

      - name: Check if version already exists
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if git tag -l "v$VERSION" | grep -q "v$VERSION"; then
            echo "Error: Tag v$VERSION already exists"
            exit 1
          fi
          echo "Version v$VERSION does not exist yet"

      - name: Update version in pyproject.toml
        run: |
          VERSION="${{ github.event.inputs.version }}"
          sed -i "s/^version = \".*\"/version = \"$VERSION\"/" pyproject.toml

      - name: Verify version update
        run: |
          VERSION="${{ github.event.inputs.version }}"
          grep "^version = \"$VERSION\"" pyproject.toml || {
            echo "Failed to update version in pyproject.toml"
            cat pyproject.toml | grep "^version"
            exit 1
          }

      - name: Update CHANGELOG.md
        run: |
          VERSION="${{ github.event.inputs.version }}"
          DATE=$(date +%Y-%m-%d)

          # Create a Python script to update the changelog
          cat > /tmp/update_changelog.py << 'EOF'
          import re
          import sys

          version = sys.argv[1]
          date = sys.argv[2]

          with open('CHANGELOG.md', 'r') as f:
              content = f.read()

          # Find the Unreleased section
          unreleased_pattern = r'## \[Unreleased\]\n\n(.*?)(?=\n## \[|$)'
          match = re.search(unreleased_pattern, content, re.DOTALL)

          if match:
              unreleased_content = match.group(1).strip()

              # Check if there's actual content (not just headers)
              has_content = False
              for line in unreleased_content.split('\n'):
                  stripped = line.strip()
                  if stripped and not stripped.startswith('#') and not stripped.startswith('---'):
                      has_content = True
                      break

              if not has_content:
                  unreleased_content = "### Added\n\n- Release v" + version

              # Create new version entry
              new_version_entry = "## [" + version + "] - " + date + "\n\n" + unreleased_content + "\n"

              # Create new unreleased section
              new_unreleased = "## [Unreleased]\n\n### Added\n\n### Changed\n\n### Fixed\n\n### Removed\n\n### Security\n\n---\n\n"

              # Replace the Unreleased section
              new_content = re.sub(unreleased_pattern, new_unreleased + new_version_entry, content, flags=re.DOTALL)

              with open('CHANGELOG.md', 'w') as f:
                  f.write(new_content)

              print("Updated CHANGELOG.md with version " + version)
          else:
              print("Could not find Unreleased section")
              sys.exit(1)
          EOF

          # Run the Python script
          python3 /tmp/update_changelog.py "$VERSION" "$DATE"

      - name: Verify CHANGELOG update
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if grep -q "## \[$VERSION\]" CHANGELOG.md; then
            echo "✅ CHANGELOG.md updated with version $VERSION"
          else
            echo "❌ Failed to update CHANGELOG.md"
            exit 1
          fi

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Commit version bump
        run: |
          VERSION="${{ github.event.inputs.version }}"
          git add pyproject.toml CHANGELOG.md
          git commit -m "chore: bump version to v$VERSION"
          git push origin HEAD:main

      - name: Create and push tag
        run: |
          VERSION="${{ github.event.inputs.version }}"
          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin "v$VERSION"
          echo "Created tag v$VERSION"

      - name: Summary
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "✅ Successfully created release v$VERSION"
          echo ""
          echo "The full release workflow has been triggered."
          echo "Track progress at: https://github.com/${{ github.repository }}/actions"
